#!/bin/sh
#
# /usr/sbin/nsm_sensor_ps-hard-restart
#
# Generated by Chef for <%= node[:fqdn] %>
#
#


# Conventional Stop
/usr/sbin/nsm_sensor_ps-stop

echo "Give it a moment to actually stop"
# Give it a moment to actually stop
/bin/sleep 30

echo "Hard Stop"
# Hard Stop 
/usr/bin/killall -9 tclsh
/usr/bin/killall -9 barnyard2
/usr/bin/killall -9 snort

# Conventional Start
/usr/sbin/nsm_sensor_ps-start

echo "Take down sniffing interfaces"
# Take all sniffing interfaces down causing rebalancing of gigastream
/usr/bin/awk -F '[\t]+' '{if ($4) system("ifconfig "$4" down")}' /etc/nsm/sensortab

echo "Waiting for Snort to Initialize, this may take up to an hour."
echo "Start: `date`"
# Check for snort initialization complete
while ! egrep "Initialization Complete" /var/log/nsm/*/snortu*.log ; do 

	/bin/sleep 1 

done;

echo "Brining up sniffing interfaces"
# Once Initialization is complete bring sniffing interfaces back up
# Rebalancing again to re-introduce sensor into gigastream.
/usr/bin/awk -F '[\t]+' '{if ($4) system("ifconfig "$4" up")}' /etc/nsm/sensortab

echo "Finish: `date`"