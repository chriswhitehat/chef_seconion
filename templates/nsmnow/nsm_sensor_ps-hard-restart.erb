#!/bin/sh
#
# /usr/sbin/nsm_sensor_ps-hard-restart
#
# Generated by Chef for <%= node[:fqdn] %>
#
#


# Conventional Stop
/usr/sbin/nsm_sensor_ps-stop

echo "Give it a moment to actually stop"
# Give it a moment to actually stop
/bin/sleep 30

echo "Hard Stop"
# Hard Stop 
/usr/bin/killall -9 tclsh
/usr/bin/killall -9 barnyard2
/usr/bin/killall -9 snort

/bin/rm /var/log/nsm/*/snortu-*.log

# Conventional Start
/usr/sbin/nsm_sensor_ps-start


# Check if sensor is a singleton (only one sensor covering this point of visibility).
# If not a singleton then roll the interfaces to stop the flow of data from upstream
# If a singleton, don't touch the interface allowing Bro/PCAP etc to function while
# waiting on Snort.  True/False is populated by Chef.
if ! <%= node[:seconion][:sensor][:singleton] %>;
then
	echo "Take down sniffing interfaces"
	# Take all sniffing interfaces down causing rebalancing of gigastream
	/usr/bin/awk -F '[\t]+' '{if ($4) system("ifconfig "$4" down")}' /etc/nsm/sensortab

	echo "Waiting for Snort to Initialize, this may take up to an hour."
	echo "Start: `date`"
	# Check for snort initialization complete
	while ! egrep "Port Based Pattern Matching Memory" /var/log/nsm/*/snortu-*.log ; do 
		true
	done;

	/usr/bin/awk -F '[\t]+' '{if ($4) system("ifconfig "$4" up")}' /etc/nsm/sensortab
	echo "Brining up sniffing interfaces"
	# Once Initialization is complete bring sniffing interfaces back up
	# Rebalancing again to re-introduce sensor into gigastream.
fi

# Restart pcap to fix down interface 100% cpu.
/usr/sbin/nsm_sensor_ps-restart --only-pcap 

echo "Finish: `date`"