#!/bin/sh
#
# /usr/local/sbin/rule-update-hard
#
# Generated by Chef for <%= node[:fqdn] %>
#
#

# Update rules
/usr/sbin/rule-update

# Take all sniffing interfaces down causing rebalancing of gigastream
/usr/bin/awk -F '[\t]+' '{if ($4) system("ifconfig "$4" down")}' /etc/nsm/sensortab

# Conventional Stop
/usr/sbin/nsm_sensor_ps-stop  >> /var/log/nsm/nsm_cron.log

# Give it a moment to actually stop
/bin/sleep 300

# Hard Stop 
/usr/bin/killall -9 tclsh  >> /var/log/nsm/nsm_cron.log
/usr/bin/killall -9 barnyard2  >> /var/log/nsm/nsm_cron.log
/usr/bin/killall -9 snort  >> /var/log/nsm/nsm_cron.log

# Conventional Start
/usr/sbin/nsm_sensor_ps-start >> /var/log/nsm/nsm_cron.log

# Check for snort initialization complete
while ! egrep "Initialization Complete" /var/log/nsm/*/snortu*.log > /dev/null; do 

	/bin/sleep 1 

done;

# Once Initialization is complete bring sniffing interfaces back up
# Rebalancing again to re-introduce sensor into gigastream.
/usr/bin/awk -F '[\t]+' '{if ($4) system("ifconfig "$4" up")}' /etc/nsm/sensortab
