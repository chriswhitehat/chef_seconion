#!/bin/sh
#
# /usr/local/sbin/rule-update-hard
#
# Generated by Chef for <%= node[:fqdn] %>
#
#

# Update rules
/usr/sbin/rule-update


# Conventional Stop
/usr/sbin/nsm_sensor_ps-stop  >> /var/log/nsm/nsm_cron.log

# Give it a moment to actually stop
/bin/sleep 300

# Hard Stop 
/usr/bin/killall -9 tclsh  >> /var/log/nsm/nsm_cron.log
/usr/bin/killall -9 barnyard2  >> /var/log/nsm/nsm_cron.log
/usr/bin/killall -9 snort  >> /var/log/nsm/nsm_cron.log

/bin/rm /var/log/nsm/*/snortu-*.log

# Conventional Start
/usr/sbin/nsm_sensor_ps-start >> /var/log/nsm/nsm_cron.log

# Check if sensor is a singleton (only one sensor covering this point of visibility).
# If not a singleton then roll the interfaces to stop the flow of data from upstream
# If a singleton, don't touch the interface allowing Bro/PCAP etc to function while
# waiting on Snort.  True/False is populated by Chef.
if ! <%= node[:seconion][:sensor][:singleton] %>;
then
	# Take all sniffing interfaces down causing rebalancing of gigastream
	/usr/bin/awk -F '[\t]+' '{if ($4) system("ifconfig "$4" down")}' /etc/nsm/sensortab

	# Check for snort initialization complete
	while ! egrep "Port Based Pattern Matching Memory" /var/log/nsm/*/snortu-*.log ; do 
		true
	done;

	# Once Initialization is complete bring sniffing interfaces back up
	# Rebalancing again to re-introduce sensor into gigastream.
	/usr/bin/awk -F '[\t]+' '{if ($4) system("ifconfig "$4" up")}' /etc/nsm/sensortab
fi

# Restart pcap to fix down interface 100% cpu.
/usr/sbin/nsm_sensor_ps-restart --only-pcap >> /var/log/nsm/nsm_cron.log